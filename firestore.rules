rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ─── Meat Types ─────────────────────────
    // Public: read only active items
    // Admin: full access
    match /meatTypes/{meatTypeId} {
      allow read: if true;
      allow write: if request.auth != null;
    }

    // ─── Orders ─────────────────────────────
    // Public: can create orders only (with validation)
    // Admin: can read and update
    match /orders/{orderId} {
      // Anyone can create an order
      allow create: if
        request.resource.data.keys().hasAll([
          'customerName', 'mobile', 'items', 'subtotal',
          'deliveryCharge', 'totalAmount', 'deliveryType',
          'address', 'status', 'idempotencyToken', 'createdAt', 'updatedAt'
        ])
        && request.resource.data.status == 'pending'
        && request.resource.data.customerName is string
        && request.resource.data.mobile is string
        && request.resource.data.mobile.size() == 10
        && request.resource.data.items is list
        && request.resource.data.items.size() > 0
        && request.resource.data.deliveryType in ['pickup', 'delivery']
        && request.resource.data.totalAmount is number
        && request.resource.data.totalAmount > 0;

      // Allow users to read their own orders if they query by mobile number
      allow read: if request.auth != null || 
                     (request.query != null && 
                      request.query.limit <= 1 && 
                      request.query.filters.size() == 1 &&
                      request.query.filters[0].op == '==' &&
                      request.query.filters[0].field == 'mobile');

      // Only authenticated admin can update status (with strict enum)
      allow update: if request.auth != null
        && request.resource.data.status in ['pending', 'confirmed', 'accepted', 'delivered', 'cancelled'];

      // No one can delete orders
      allow delete: if false;
    }

    // ─── Default deny ───────────────────────
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
